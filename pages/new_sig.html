<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="../css/create_new_sig.css" rel="stylesheet">

    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <title>SIGFinder - Criar Catálogo</title>

</head>

<body onload="init()">

    <nav>
        <div class="nav-wrapper indigo darken-1">
            <a href="#" class="brand-logo center">SIGFinder</a>
            <div class="col s12 hide-on-med-and-down" style="margin-left: 20px">
                <a href="/index.html" class="breadcrumb waves-light">Home</a>
                <a href="#!" class="breadcrumb waves-light">Criar Catálogo</a>
            </div>
        </div>
    </nav>

    <ul id="slide-out" class="side-nav mySideBar">
        <li>
            <a href="#!">Novo Softgoal</a>
        </li>

        <div class="row">
            <form class="col s12">
                <div class="row">
                    <div id="parentDiv" class="input-field col s12">
                        <input placeholder="" id="parent_softgoal" type="text" class="validate">
                        <label for="parent_softgoal">Parent *</label>
                    </div>

                    <div class="input-field col s12">
                        <input placeholder="" id="name_softgoal" type="text" class="validate">
                        <label for="name_softgoal">Nome *</label>
                    </div>

                    <div class="input-field col s12">
                        <select id="selectNFRType">
                            <option value="1" selected>NFR Softgoal</option>
                            <option value="2">Operacionalização</option>
                            <option value="3">Claim Softgoal</option>
                        </select>
                        <label>Tipo de Softgoal *</label>
                    </div>

                    <div class="input-field col s12">
                        <select id="selectContributionType">
                            <option value="0" selected></option>
                            <option value="1">AND</option>
                            <option value="2">OR</option>
                        </select>
                        <label>Contribuição</label>
                    </div>

                    <div class="input-field col s12">
                        <select id="selectContributionTypeCatalog">
                            <option value="0" selected></option>
                            <option value="1">BREAK</option>
                            <option value="2">HURT</option>
                            <option value="3">UNKNOWN</option>
                            <option value="4">HELP</option>
                            <option value="5">SOME (-)</option>
                            <option value="6">SOME (+)</option>
                        </select>
                        <label>Tipo de Contribuição (catálogo)</label>
                    </div>

                    <div class="input-field col s12">
                        <select id="selectEvaluationProcedure">
                            <option value="0" selected></option>
                            <option value="1">DENIED</option>
                            <option value="2">WEAKLY_DENIED</option>
                            <option value="3">UNDECIDED</option>
                            <option value="4">WEAKLY_SATISFICED</option>
                            <option value="5">SATISFICED</option>
                            <option value="6">CONFLICT</option>
                        </select>
                        <label>Tipo de Avaliação</label>
                    </div>

                    <div class="col s12">

                        <label>Prioridade?</label>
                        <br>
                        <input class="with-gap " name="isPriorityGroup" type="radio" id="rbPrioritySim" />
                        <label for="rbPrioritySim">Sim</label>

                        <input class="with-gap" name="isPriorityGroup" type="radio" checked="true" id="rbPriorityNao" />
                        <label for="rbPriorityNao">Não</label>
                    </div>

                    <div class="col s12 divButtonCriarSoftgoal">
                        <a class="waves-effect waves-light green btn buttonCriarSoftgoal">Criar</a>
                    </div>

                </div>
            </form>
        </div>
    </ul>

    <div id="divInitNewCatalog" class="divInitNewCatalog">

        <img src="../imgs/icon_search.png" class="imageNoSoftgoals" alt="">
        <div class="divShowMsgNoSoftgoal">
            <p>Você ainda não começou a criar seu SIG.</p>
            <p>Aperte no botão "+" para começar a criar um.</p>
        </div>
        <a id="btStartCatalog" data-activates="slide-out" class="button-collapse btn-floating btn-large waves-effect waves-light green sidenav-trigger show-on-large fabNewSoftgoal">
            <i class="material-icons">add</i>
        </a>
    </div>

    <!--Div containing the goJS graph-->
    <div id="myCatalogSIG" class="divDiagramSIG">

    </div>

    <div id="modalCatalog" class="modal">
        <div class="modal-content">
            <h4>Cadastrar Catálogo</h4>
            <div class="divider"></div>
            <div class="row">
                <form id="formNewCatalog" action="" class="col s12">
                    <div class="input-field col s12">
                        <input placeholder="Ex: João, joao@gmail.com" id="owner_catalog" type="text" class="validate"
                            required="">
                        <label for="owner_catalog">Criador *</label>
                    </div>

                    <div class="input-field col s12">
                        <input placeholder="Ex: João, joao@gmail.com; Maria, maria@gmail.com;" id="authors_catalog"
                            type="text" class="validate" required="">
                        <label for="authors_catalog">Lista de Autores *</label>
                    </div>

                    <div class="input-field col s12">
                        <input placeholder="Ex: Sua referência" id="reference_catalog" type="text" class="validate"
                            required="">
                        <label for="reference_catalog">Referência *</label>
                    </div>

                    <div class="input-field col s12">
                        <input placeholder="Ex: 2018" id="year_catalog" type="text" class="validate" required="">
                        <label for="year_catalog">Ano *</label>
                    </div>

                    <div class="input-field col s12">
                        <div id="chips_applicationDomain_catalog" class="chips validate" required=""></div>
                        <label for="chips_applicationDomain_catalog">Domínio de Aplicação * (pressione "ENTER" para
                            cada domínio)</label>
                    </div>

                    <div class="input-field col s12">
                        <div id="chips_area_catalog" class="chips validate" required=""></div>
                        <label for="chips_area_catalog">Area * (pressione "ENTER" para cada area)</label>
                    </div>

                    <div class="input-field col s12">
                        <textarea id="description_catalog" class="materialize-textarea "></textarea>
                        <label for="description_catalog">Descrição</label>
                    </div>

                    <div class="modal-footer">
                        <div class="input-field col s12">
                            <a href="#!" class="modal-action modal-close waves-effect waves-light red btn-flat white-text">Fechar</a>
                            <input type="submit" name="action" class="modal-action waves-effect waves-light green btn-flat white-text"
                                value="Enviar">
                        </div>
                    </div>

                </form>


            </div>
        </div>

    </div>


    <!-- Modal Structure -->
    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4>Excluir Softgoal</h4>
            <p id="msgExcluirSoftgoal">Você realmente deseja excluir este softgoal? </p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-action modal-close waves-effect waves-light blue btn-flat white-text">Cancelar</a>
            <a id="btnDeleteSoftgoal" href="#!" class="modal-action modal-close waves-effect waves-light red btn-flat white-text">Excluir</a>
        </div>
    </div>


    <div class="action-btn fabAddSoftgoal fixed-action-btn">
        <a id="fabAddSoftgoal2" data-activates="slide-out" class="button-collapse sidenav-trigger show-on-large btn-floating btn-large green">
            <i class="large material-icons">add</i>
        </a>
        <ul>
            <!-- Modal Trigger -->
            <li>
                <a class="btn-floating blue waves-effect waves-light btn modal-trigger" href="#modalCatalog">
                    <i class="material-icons">cloud_done</i>
                </a>
            </li>
            <li>
                <a class="btn-floating red darken-1 btn modal-trigger" href="#modal1">
                    <i class="material-icons">delete</i>
                </a>
            </li>
        </ul>
    </div>


    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js">
    </script>

    <script>

        $('.button-collapse').sideNav({
            menuWidth: 300, // Default is 240
            edge: 'right', // Choose the horizontal origin
            closeOnClick: true // Closes side-nav on <a> clicks, useful for Angular/Meteor
        }
        );

        // jQuery command needed to select works (materialize)
        $('select').material_select();

        $('.tooltipped').tooltip({ delay: 50 });

        $('.modal').modal();

        $('.chips').material_chip();

        let divInitNewCatalog = document.getElementById("divInitNewCatalog");
        let myCatalogSIG = document.getElementById("myCatalogSIG");
        let fabNewCatalog = document.getElementById("btStartCatalog");
        let divShowMsgNoSoftgoal = document.querySelector(".divShowMsgNoSoftgoal");
        let inputParentDiv = document.getElementById("parentDiv");
        let fabAddSoftgoal = document.querySelector(".fabAddSoftgoal");
        let fabAddSoftgoal2 = document.getElementById("fabAddSoftgoal2");
        let formNewCatalog = document.getElementById("formNewCatalog");
        let btnDeleteSoftgoal = document.getElementById("btnDeleteSoftgoal");
        let btnEditSoftgoal = document.getElementById("btnEditSoftgoal");

        myCatalogSIG.hidden = true;
        fabAddSoftgoal.hidden = true;

        fabNewCatalog.addEventListener("click", function () {

            divInitNewCatalog.hidden = true;
            fabNewCatalog.hidden = true;
            divShowMsgNoSoftgoal.hidden = true;
            inputParentDiv.hidden = true;

            myCatalogSIG.hidden = false;


        });

        btnDeleteSoftgoal.addEventListener("click", function () {
            console.log("delete softgoal");

            let keyNodeToDelete = softgoalClickedNow.key;
            myDiagram.model.removeNodeData(softgoalClickedNow);

            Materialize.toast("Softgoal excluído!", 1500, "red");
        });

        let btCreateNewSoftgoal = document.querySelector(".buttonCriarSoftgoal");
        btCreateNewSoftgoal.addEventListener("click", function () {

            let inputParentDiv = document.getElementById("parentDiv");
            let inputParent = document.getElementById("parent_softgoal");
            let inputName = document.getElementById("name_softgoal");
            let selectNFRType = document.getElementById("selectNFRType");
            let selectContributionType = document.getElementById("selectContributionType");
            let selectContributionTypeCatalog = document.getElementById("selectContributionTypeCatalog");
            let selectEvaluationProcedure = document.getElementById("selectEvaluationProcedure");
            let radioButtonPriority = document.querySelectorAll(".with-gap");

            let key;
            let parent;
            if (softgoalClickedNow == null) {
                key = 1;
                parent = inputParent.value;
            } else {
                key = softgoalClickedNow.key + 1;
                parent = softgoalClickedNow.key;
            }

            //lembrar de colocar um outro select que é alimentado pelos softgoals que estão no SIG
            //dessa forma, quando for adicionar o SIG, o valor parent já vai ser Number e não String como está sendo agora.

            let name = inputName.value;
            let nfrType = selectNFRType.value;
            let contributionType = selectContributionType.value;
            let contributionTypeCatalog = selectContributionTypeCatalog.value;
            let evaluationProcedure = selectEvaluationProcedure.value;
            let isPriority;

            if (radioButtonPriority[0].checked)
                isPriority = true;
            else
                isPriority = false;

            let softgoal = new Object();

            softgoal.key = key;
            softgoal.parent = parent;
            softgoal.name = name;
            softgoal.nfrType = nfrType;
            softgoal.contributionType = contributionType;
            softgoal.contributionTypeCatalog = contributionTypeCatalog;
            softgoal.evaluationProcedure = evaluationProcedure;
            softgoal.priority = isPriority;
            softgoal.softgoalList = [];

            addSoftgoal(softgoal);

            clearValuesForm();

        });

        fabAddSoftgoal2.addEventListener("click", function () {

            let inputParent = document.getElementById("parent_softgoal");
            inputParent.value = softgoalClickedNow.name;
            inputParentDiv.hidden = false;

        });

        formNewCatalog.addEventListener("submit", function (e, obj) {

            let inputOwner = document.getElementById("owner_catalog").value;
            let inputAuthors = document.getElementById("authors_catalog").value;
            let reference = document.getElementById("reference_catalog").value;
            let year = document.getElementById("year_catalog").value;
            let inputApplicationDomain = document.getElementById("chips_applicationDomain_catalog").childNodes;
            let inputArea = document.getElementById("chips_area_catalog").childNodes;
            let description = document.getElementById("description_catalog").value;

            let applicationDomain = getApplicationDomainsFromChip(inputApplicationDomain);
            let area = getAreasFromChip(inputArea);
            let owner = new Object();
            let infoOwner = inputOwner.split(",");
            owner.name = infoOwner[0];
            owner.email = infoOwner[1];

            let catalog = new Object();

            catalog.id = null;
            catalog.reference = reference;
            catalog.year = year;
            catalog.description = description;
            catalog.owner = owner;
            catalog.softgoalMain = nodeDataArray[0];
            catalog.notesList = [];
            catalog.authors = getAuthors(inputAuthors);
            catalog.areasList = getAreasFromChip(inputArea);
            catalog.applicationDomainList = getApplicationDomainsFromChip(inputApplicationDomain);
            console.log(catalog);
            sendNewCatalog(catalog);
        });

        function getApplicationDomainsFromChip(chipsApplicationDomain) {

            let arrayApplicationDomain = [];

            for (let i = 0; i < chipsApplicationDomain.length - 1; i++) {

                let applicationDomain = new Object();
                applicationDomain.text = chipsApplicationDomain[i].textContent.replace("close", "");
                arrayApplicationDomain.push(applicationDomain);
            }

            return arrayApplicationDomain;
        };

        function getAreasFromChip(chipsAreas) {

            let arrayArea = [];

            for (let i = 0; i < chipsAreas.length - 1; i++) {

                let area = new Object();
                area.text = chipsAreas[i].textContent.replace("close", "");
                arrayArea.push(area);
            }

            return arrayArea;
        };

        function getAuthors(inputAuthors) {

            inputAuthors = inputAuthors.split(";");
            let arrayAuthors = [];

            for (let i = 0; i < inputAuthors.length; i++) {

                let eachAuthor = inputAuthors[i].split(",");

                let person = new Object();
                person.name = eachAuthor[0];
                person.email = eachAuthor[1];
                arrayAuthors.push(person);
            }

            return arrayAuthors;
        }

        function sendNewCatalog(catalog) {

            let url = "http://localhost:8080/catalogs"
            let xhttp = new XMLHttpRequest();

            catalog = JSON.stringify(catalog);

            xhttp.open("POST", url, true);
            xhttp.setRequestHeader("Content-Type", "application/json");

            xhttp.onreadystatechange = function () {
                console.log(xhttp.status);
                var response = JSON.parse(xhttp.responseText);
                if (xhttp.readyState == 4 && xhttp.status == "201") {
                    console.table(response);
                } else {
                    console.error(response);
                }
            };

            xhttp.send(catalog);
        }

        function clearValuesForm(){
            
            let inputParentDiv = document.getElementById("parentDiv");
            let inputParent = document.getElementById("parent_softgoal");
            let inputName = document.getElementById("name_softgoal");
            let selectNFRType = document.getElementById("selectNFRType");
            let selectContributionType = document.getElementById("selectContributionType");
            let selectContributionTypeCatalog = document.getElementById("selectContributionTypeCatalog");
            let selectEvaluationProcedure = document.getElementById("selectEvaluationProcedure");
            let radioButtonPriority = document.querySelectorAll(".with-gap");

            //clean the fields TODO
            inputName.value = "";
            inputParent.value = "";
            selectNFRType.options[0].setAttribute("selected", "true");
        }

    </script>

    <script src="../js/go.js"></script>
    <script src="../js/commomFunctions.js"></script>
    <script src="../js/newSIG.js"></script>

</body>

</html>